<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>個別訪問管理アプリ</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (JSXをブラウザで変換するため) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK (バージョン9系) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // ★★★重要：ここにFirebaseの設定を貼り付けてください★★★
        // Firebaseコンソールの「プロジェクトの設定」＞「マイアプリ」からコピーできます
        const firebaseConfig = {
            apiKey: "AIzaSy...", 
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };
        // ★★★貼り付けここまで★★★

        // グローバル変数にセットしてReactから使えるようにする
        window.firebaseModules = {
            app: initializeApp(firebaseConfig),
            auth: getAuth(),
            db: getFirestore(),
            signInAnonymously,
            onAuthStateChanged,
            collection,
            addDoc,
            query,
            onSnapshot,
            orderBy,
            serverTimestamp,
            deleteDoc,
            doc
        };
        
        // Reactアプリの開始を通知
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        /* スクロールバーを隠すなどの微調整 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            touch-action: manipulation; /* スマホでのダブルタップ拡大防止 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // --- アイコンコンポーネント (SVG) ---
        const Icons = {
            MapPin: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            User: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Plus: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            CheckCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            XCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>,
            HelpCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>,
            Home: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Trash2: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Search: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        };

        const RANKS = {
            A: { label: 'A: 確実 (支持)', color: 'bg-red-500', text: 'text-red-600', icon: Icons.CheckCircle },
            B: { label: 'B: 脈あり', color: 'bg-orange-400', text: 'text-orange-500', icon: Icons.HelpCircle },
            C: { label: 'C: 厳しい', color: 'bg-gray-400', text: 'text-gray-500', icon: Icons.XCircle },
            ABSENT: { label: '留守', color: 'bg-blue-400', text: 'text-blue-500', icon: Icons.Home },
        };

        // --- Components ---

        const LoadingScreen = () => (
            <div className="flex items-center justify-center h-screen bg-gray-50">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600"></div>
                <div className="ml-4 text-gray-600">読み込み中...</div>
            </div>
        );

        const RankButton = ({ rankKey, selected, onClick }) => {
            const config = RANKS[rankKey];
            const Icon = config.icon;
            
            return (
                <button
                    type="button"
                    onClick={() => onClick(rankKey)}
                    className={`
                        relative w-full p-4 rounded-xl border-2 transition-all duration-200 flex flex-col items-center justify-center gap-2
                        ${selected 
                        ? `border-${config.color.replace('bg-', '')} bg-white shadow-md ring-2 ring-offset-1 ring-${config.color.replace('bg-', '')}` 
                        : 'border-gray-200 bg-gray-50 hover:bg-white'}
                    `}
                >
                    <Icon className={`w-8 h-8 ${config.text}`} />
                    <span className={`text-sm font-bold ${selected ? 'text-gray-900' : 'text-gray-500'}`}>
                        {config.label.split(':')[0]}
                    </span>
                    {selected && (
                        <div className={`absolute top-2 right-2 w-3 h-3 rounded-full ${config.color}`} />
                    )}
                </button>
            );
        };

        const App = () => {
            const [isFirebaseReady, setIsFirebaseReady] = React.useState(false);
            const [user, setUser] = React.useState(null);
            const [visits, setVisits] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [view, setView] = React.useState('list'); 
            const [filterRank, setFilterRank] = React.useState('ALL');
            const [searchTerm, setSearchTerm] = React.useState('');
            
            const [formData, setFormData] = React.useState({
                name: '',
                address: '',
                rank: 'B',
                note: ''
            });

            // Firebaseの準備待ち
            React.useEffect(() => {
                if (window.firebaseModules) {
                    setIsFirebaseReady(true);
                } else {
                    window.addEventListener('firebase-ready', () => setIsFirebaseReady(true));
                }
            }, []);

            // 認証とデータ取得
            React.useEffect(() => {
                if (!isFirebaseReady) return;

                const { auth, signInAnonymously, onAuthStateChanged } = window.firebaseModules;

                signInAnonymously(auth).catch((error) => {
                    console.error("Auth failed:", error);
                    alert("ログインに失敗しました。Firebaseの設定を確認してください。");
                });

                const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) setLoading(false);
                });
                return () => unsubscribeAuth();
            }, [isFirebaseReady]);

            React.useEffect(() => {
                if (!user || !isFirebaseReady) return;

                const { db, collection, query, onSnapshot, orderBy } = window.firebaseModules;
                
                // コレクション名を共通の 'visits' にすることで、全ユーザー（運動員）でデータを共有できます。
                // 個人ごとに分けたい場合は `users/${user.uid}/visits` に変更してください。
                // ここでは「チームで共有」を想定して、一つのコレクションに集約します。
                const q = query(
                    collection(db, 'election_visits'),
                    orderBy('createdAt', 'desc')
                );

                const unsubscribeDocs = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        createdAt: doc.data().createdAt?.toDate() || new Date()
                    }));
                    setVisits(data);
                    setLoading(false);
                }, (error) => {
                    console.error("Data fetch error:", error);
                    // インデックスエラー回避のため、ソートなしで再試行などのロジックを入れることも可能
                    setLoading(false);
                });

                return () => unsubscribeDocs();
            }, [user, isFirebaseReady]);

            const handleAddVisit = async (e) => {
                e.preventDefault();
                if (!user || !formData.address) return;

                const { db, collection, addDoc, serverTimestamp } = window.firebaseModules;

                try {
                    await addDoc(collection(db, 'election_visits'), {
                        ...formData,
                        authorId: user.uid, // 誰が書いたか
                        createdAt: serverTimestamp()
                    });
                    setFormData({ name: '', address: '', rank: 'B', note: '' }); 
                    setView('list');
                } catch (error) {
                    console.error("Error adding document: ", error);
                    alert("保存に失敗しました。");
                }
            };

            const handleDelete = async (id) => {
                if(!confirm("この記録を削除しますか？")) return;
                
                const { db, doc, deleteDoc } = window.firebaseModules;
                try {
                    await deleteDoc(doc(db, 'election_visits', id));
                } catch(err) {
                    console.error(err);
                    alert("削除できませんでした");
                }
            };

            const filteredVisits = visits.filter(v => {
                const matchesRank = filterRank === 'ALL' || v.rank === filterRank;
                const matchesSearch = 
                    v.name.includes(searchTerm) || 
                    v.address.includes(searchTerm) || 
                    v.note.includes(searchTerm);
                return matchesRank && matchesSearch;
            });

            if (!isFirebaseReady) return <LoadingScreen />;
            if (loading) return <LoadingScreen />;

            // --- View: Add ---
            if (view === 'add') {
                return (
                    <div className="min-h-screen bg-gray-50 flex flex-col">
                        <div className="bg-white px-4 py-4 shadow-sm border-b sticky top-0 z-10 flex items-center justify-between">
                            <button onClick={() => setView('list')} className="text-gray-500">キャンセル</button>
                            <h1 className="text-lg font-bold text-gray-800">訪問記録を追加</h1>
                            <button 
                                onClick={handleAddVisit} 
                                className="text-red-600 font-bold disabled:opacity-50"
                                disabled={!formData.address}
                            >
                                保存
                            </button>
                        </div>

                        <div className="p-4 space-y-6 max-w-lg mx-auto w-full flex-1">
                            <section>
                                <label className="block text-sm font-medium text-gray-700 mb-2">反応 (ランク)</label>
                                <div className="grid grid-cols-2 gap-3">
                                    {Object.keys(RANKS).map(key => (
                                        <RankButton 
                                            key={key} 
                                            rankKey={key} 
                                            selected={formData.rank === key} 
                                            onClick={(r) => setFormData({...formData, rank: r})} 
                                        />
                                    ))}
                                </div>
                            </section>

                            <section className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">住所 (必須)</label>
                                    <div className="relative">
                                        <div className="absolute left-3 top-3 text-gray-400">
                                            <Icons.MapPin className="w-5 h-5"/>
                                        </div>
                                        <input
                                            type="text"
                                            placeholder="例: 〇〇町 1-2-3"
                                            className="w-full pl-10 p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                            value={formData.address}
                                            onChange={e => setFormData({...formData, address: e.target.value})}
                                            required
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">お名前 (表札など)</label>
                                    <div className="relative">
                                        <div className="absolute left-3 top-3 text-gray-400">
                                            <Icons.User className="w-5 h-5"/>
                                        </div>
                                        <input
                                            type="text"
                                            placeholder="例: 山田 太郎"
                                            className="w-full pl-10 p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                            value={formData.name}
                                            onChange={e => setFormData({...formData, name: e.target.value})}
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">メモ</label>
                                    <textarea
                                        placeholder="要望や会話の内容..."
                                        className="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-transparent h-24"
                                        value={formData.note}
                                        onChange={e => setFormData({...formData, note: e.target.value})}
                                    />
                                </div>
                            </section>
                        </div>
                    </div>
                );
            }

            // --- View: List ---
            return (
                <div className="min-h-screen bg-gray-100 flex flex-col max-w-md mx-auto shadow-2xl overflow-hidden relative">
                    <header className="bg-red-700 text-white p-4 shadow-md z-10">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Icons.MapPin className="w-5 h-5" />
                                個別訪問管理
                            </h1>
                            <div className="text-xs bg-red-800 px-2 py-1 rounded">
                                {visits.length}件
                            </div>
                        </div>

                        <div className="relative">
                            <div className="absolute left-3 top-2.5 text-red-200">
                                <Icons.Search className="w-4 h-4" />
                            </div>
                            <input 
                                type="text" 
                                placeholder="名前や住所で検索..." 
                                className="w-full pl-9 pr-4 py-2 bg-red-800/50 text-white placeholder-red-200 rounded-lg focus:outline-none focus:bg-red-800 border border-transparent focus:border-red-400 text-sm"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                    </header>

                    <div className="bg-white border-b flex overflow-x-auto no-scrollbar">
                        <button 
                            onClick={() => setFilterRank('ALL')}
                            className={`px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors ${filterRank === 'ALL' ? 'border-red-600 text-red-600' : 'border-transparent text-gray-500'}`}
                        >
                            すべて
                        </button>
                        {Object.keys(RANKS).map(key => (
                            <button 
                                key={key}
                                onClick={() => setFilterRank(key)}
                                className={`px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors ${filterRank === key ? `border-${RANKS[key].color.replace('bg-', '')} text-gray-900` : 'border-transparent text-gray-500'}`}
                            >
                                {RANKS[key].label.split(':')[0]}
                            </button>
                        ))}
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-24">
                        {filteredVisits.length === 0 ? (
                            <div className="text-center py-10 text-gray-400">
                                <p>データがありません</p>
                                <p className="text-sm mt-2">右下の＋ボタンで記録を追加</p>
                            </div>
                        ) : (
                            filteredVisits.map(visit => {
                                const RankIcon = RANKS[visit.rank].icon;
                                return (
                                    <div key={visit.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:scale-[0.99] transition-transform">
                                        <div className="flex justify-between items-start mb-2">
                                            <div className="flex items-center gap-2">
                                                <span className={`px-2 py-1 rounded text-xs font-bold text-white ${RANKS[visit.rank].color}`}>
                                                    {RANKS[visit.rank].label.split(' ')[0]}
                                                </span>
                                                <span className="text-xs text-gray-400">
                                                    {visit.createdAt.toLocaleDateString()} {visit.createdAt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                </span>
                                            </div>
                                            <button onClick={() => handleDelete(visit.id)} className="text-gray-300 hover:text-red-500">
                                                <Icons.Trash2 className="w-4 h-4" />
                                            </button>
                                        </div>
                                        
                                        <h3 className="font-bold text-gray-900 text-lg mb-1">
                                            {visit.name || "（名称なし）"}
                                        </h3>
                                        
                                        <div className="flex items-center text-gray-600 text-sm mb-2">
                                            <Icons.MapPin className="w-3 h-3 mr-1" />
                                            {visit.address}
                                        </div>

                                        {visit.note && (
                                            <div className="bg-gray-50 p-2 rounded text-sm text-gray-600 mt-2 border-l-2 border-gray-300">
                                                {visit.note}
                                            </div>
                                        )}
                                    </div>
                                );
                            })
                        )}
                    </div>

                    <button 
                        onClick={() => setView('add')}
                        className="fixed bottom-6 right-6 w-14 h-14 bg-red-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-red-700 active:scale-90 transition-all z-20"
                    >
                        <Icons.Plus className="w-8 h-8" />
                    </button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

